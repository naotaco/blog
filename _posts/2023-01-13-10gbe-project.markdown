---
layout: single
title: 自宅10GbE計画
date: 2023-01-13 23:32:30 +09:00
categories: network diary pc
---

10GbEまでの道程。

# 現状

マンションに住んでいて、よくある共有ネットワーク（LAN方式）がある（解約不可能）。時間帯によっては遅くなるし安定しないので、フレッツ光の戸建て向けプランを別途引いている。これはファミリー・ギガラインタイプで1Gbps回線である。プロバイダはSo-netにしてある。

ルータはRTX810を使っていて、IPoE接続。IPv4はTransix（DS-Lite）。V6プラスも気になっているのだがRTX810はMAP-Eに対応していないので現状ではDS-Lite一択である。

速度は（Ooklaやfast.comで計測している感じ）IPv4だと300Mbpsくらい、v6だと600Mbpsくらい出ている。不満があるのかというと全くない。

一つ気になっていることとして、テレワーク時に使用するVPNがIPv4だと安定しないということが挙げられる。「IPv4だと」と書いているように、理由はわからないがVPNの接続をIPv6にすると解消する[^1]。なので、別に困ってはいない。もしかしたらDS-LiteのNAT変換用ポート上限（1024）というやつが効いているのかも？と思っているので、できればMAP-Eも試してみたいと思っている。しかしMAP-Eの方が遅いという話も聞いているので、どっちがいいやら……。

Wi-Fiは適当に買ったTP-LinkのArcher C4000/AをAPモードで設置している。1625Mbpsでリンクすると書いてあるが手元のThinkPadの表示を見ると833Mbps？でリンクしている（ことがある）っぽい。実際には400Mbpsくらいで頭打ちになっているようにも見える。


# フレッツ光クロス

宅内はマンションの壁内配線（部屋間の配線）に使われているLANケーブルがCat5eなので1GbEが上限なのかと思っていた。が、実は5eでも2.5GbEなら通るということを知って、俄然興味が沸いてきた次第。現状600Mbpsのものが2Gbps出たらとても楽しいと思う（楽しいだけ）。

#### 1/13

ということで、フレッツのプラン変更を申し込んでみた。

[https://flets.com/application/change.html](https://flets.com/application/change.html) からフレッツ光クロスへの変更を申し込む。すると工事費が出てきて、2200円と表示されていた（たぶん）。申し込みが完了すると、申し込みが完了しました、というだけの無のメールが届く。曰く、

> ご利用場所の設備状況、またはご入力内容の確認が必要な場合には、担当者よりお電話やメールにてご連絡いたします

とのことで、沙汰を待てということなのだろう。工事費2200円と表示されていたように記憶しているが、[工事費のページ](https://flets.com/cross/const_fee_mn.html)を見るとこの金額はONUを自分で設置する場合の金額のように見える。実質的に工事不要でONUを交換するだけで良いなら最高なのだが、まあこのへんは実際にやってみないとわからないのであまり期待しないことにする。

#### 1/14

フレッツから電話があり、とりのがす。するとメールが2通届く。なんとメッセージボックスのログインIDとパスワードがそれぞれ別のメールで。どうにか開くと、電話したけどつながらなかったので折り返してほしいという旨だけが書かれている。

電話をかけると、いくつか確認をされたあとにWebからの受付の内容をあらためて確認される（意味ある？）。そして光クロスは今利用中のSo-netは使えないということをあらためて（Web申し込みの段階で念押しチェックボックスがあったんだけど）確認される（意味ある？）。そして、うちの家にはすぐに工事できないため、工事日程がわかったらまた連絡するということだけ伝えられて終了。これ最初からメール1通で済んだのでは？ 次の連絡は早ければ3営業日程度で、といっていた（適当なことを言うのはやめてほしい）。

#### 1/27

2週間経過して忘れた頃に電話がかかってきた。曰く、

- 最短2/13に工事（それ以降であれば調整可） → 2/13でお願いします
- 工事は宅内のみ。ONUの交換。
- 工事費用は8500円くらい（もちろんちゃんと受付の人は言っていたが私が忘れた）
  - 翌月？の月額に追加で引き落とし
- 月額費用は6000円くらい（同上）
  - いまの1Gプランは5400円くらいで、にねん割があるので5000円くらいになってる（詳細失念）
  - 光クロスににねん割はない。
  - よって実質1000円くらい値上がりする
- プロバイダをそれまでに契約しておいてほしい（何度目？）
  - 工事のタイミングで切り替わってしまうので、それまでに契約しないとだめ
- 工事完了後、プロバイダの情報がおりてくる（？）のに時間がかかるという報告がある。この間接続できない。
  - これについてはプロバイダに問い合わせしてほしい
  - 把握している範囲では最悪2-3日といったケースもある
- 10GbE対応のルータが必要になるが、レンタルするか？ → 不要で回答
- 開通のお知らせを工事の数日前に送る

ONU交換のみなら自分でやって費用は2200円という話も見かけたが、どうやらそうはならなかったらしい。まあ自分でおっかなびっくりやるのも怖いしお任せできる方が安心ではある。何よりマンションなので工事が宅内のみというのは助かる。もしかしたら奇跡的にスムーズに工事が完了するかもしれない。

申し込み画面で出ていた2200円とかいうやつはなんだったんだ。

#### 2/9

「開通のご案内」が届く。ここに書いてある番号がプロバイダ契約に必要なので、多分この日まで申し込むことはできない（プロバイダについては別項で述べる）。

#### 2/13

予定通り工事の人が来る。前日に電話で「15分くらいで簡単に終わる工事なんで」と死亡フラグを立てていたのでわくわくしながら見ていたが、あっさり本当に15分くらいで終わってしまった。ONUが若干大きくなったくらいで（従来もいわゆる小型ONUではなかった）、見た目にはほとんど差がわからない。この日は接続できず。

#### 2/15

無事開通🎉 詳細は後述。

## プロバイダ

フレッツ光クロスは対応プロバイダが限られており、いま使っているSo-netは使えない。有名どころではASAHIネットや＠Niftyなどがあるようなのでこのあたりにしたいが、ASAHIネットは独自DS-Liteらしく（自身がVNE）ルータが対応しているものがさらに少ない模様。＠NiftyはMAP-Eで、OCNのやつらしい。こちらは新しいRTXなら対応しているはずなので問題なさそう。

ここまでの感じだと＠Niftyにしたい気持ちになるが、申し込みが電話のみだったので一気に萎えて一旦保留にした。あと帯域制限の噂が絶えない。

ということで下記の要件にあてはまるプロバイダを探したい。

- 光クロス対応
- MAP-E（JPNEかOCNか）でIPv4 over IPv6を提供している

申し込みはお客様番号必要なので、開通のお知らせが届き次第か。

光クロスの情報はただでさえ少ないのだが、1Gbps超での速度情報とか帯域制限の情報となるとぐぐってもぜんぜん出てこない。厳しい。特に速度制限については、PPPoEの制限はどうでもいいとしても、transixがユーザ（ISP）の要求でかけてる帯域制限なんかもあるらしくもうなんもわからん。


さらに調べているとCyberBBとOpenCircuitが浮上してきた。

CyberBBは2000円くらいだったのでよさそうだが、情報があまりにないので問い合わせのメールを出してみた。  
丁寧に回答くださったので、ひとまずここにしてみようと思う。

ちょっとわかりづらかったが、要は「光クロス」プランを契約すればJPNEのやつも使えるということだ。まあ光クロスではPPPoEが使えないわけだから、v6プラスが使えないプランというのは普通の家庭においては全く使いようがないということになるし、そりゃそうだろうという話であるが。

> 
> 下記に記載しますので、ご検討の程よろしくお願いいたします。
> 
> >1. 光クロスのプラン(1900円/月）を契約すればいわゆるv6プラス
> >（MAP-E方式でのIPv4 over IPv6通信）も利用できるのでしょうか。
> >あるいは、v6プラスプラン（1200円/月）と両方を契約する必要がありますか？
> 
> NTT側の回線品目である「光クロス」回線にて、弊社v6プラスはご利用可能でご
> ざいます。v6プラスご利用希望の場合には、そのご利用環境をご用意ください。
> 
> 光クロスご利用の場合は、「光クロス」のお申し込みが必要です。  
> https://cyberbb.com/cross.php
> 
> v6プラスご利用の場合は、「v6プラス」のお申し込みが必要です。  
> https://cyberbb.com/v6plus.php
> 
> ※いずれも対応地域のご確認をお願いします。  
> ※光クロスとv6プラスは回線種別が違うため同時にはご利用できません。
> 
> 弊社v6プラスは、IPoE方式によるIPv6通信と、IPv4 over IPv6によるIPv4通信の
> 両方がご利用頂けるサービスでございます。  
> そのため、v6プラスをご利用頂いているということは、IPv4 over IPv6による
> IPv4通信もご利用頂いている事となります。
> 
> >2. 各プランに最低利用期間などはありますでしょうか
> 
> 最低ご利用期間は2ケ月となります。  
> 日割り計算はございません。月単位でのご契約となります。
> 
> >3. v6プラス利用時、グローバルIPv4アドレスは他ユーザと共用かと思いますが、
> >利用可能なポート数の上限はいくつでしょうか
> 
> IPv4グローバル固定IPは即時発行可能です。
> 通常は共用IPv4アドレスとなります。
> 
> IPv6アドレスは半固定となります。
> NTT局舎内などで大規模工事がある場合などに変更される場合がございます。
> 
> 申し訳ございませんが、ポート数上限数に関しましては、開示することが出来な
> い情報でございます。何卒ご理解頂ければと存じます。
> 
> >4. v6プラス利用時に帯域制限はかけていますか？
> 
> 現在、帯域制限はありませんが、将来的に保証できるものではございません。
> 他と比べて著しく高い値の場合、ご相談させていただく場合があるかもしれません。
> 
> >5. いただいた回答をブログ等に掲載してもよろしいでしょうか？
> 
> 正式な回答ですので、ブログへの掲載に関して制限はありません。
> ただし、抜粋せず全文をご記載ください。
> 
> 以上の件、よろしくお願いいたします。
> ご不明な点などがございましたら遠慮なくお問い合わせください。

#### 申し込み

開通のご案内を待っていたので、申し込みは2/9の夜中とギリギリになってしまった。ほぼ翌営業日が光クロスの工事日であるにもかかわらず2/13に間に合わせてくれるとのこと。ありがたい。

失礼ながら相当古くさいWebから申し込むと翌朝すぐ担当の方からメールがくる。なんとGmailはNG。独自ドメインのメールアドレスならかろうじて通ったが、なかったらどうすればよかったんだ。また申し込み画面でレンタルルータか自前のルータかを聞かれるのだが、間違えてレンタルルータを選択していた。ここを間違えると何かの手続きが違うらしく（一体何なんだ？）メールで訂正して機種（RTX1300）を伝えたところ問題ないとのことであった。

#### 2/13 工事当日

工事完了直後にルータ（RTX1300）を設定してみるが、接続できず。プロバイダのご担当に完了した旨を伝えたところ

> ただ今JPIXに確認いたしましたところ、「アクセス回線状態エラー」が出ているとの事です。  
> エラーの内容は、現地工事は完了しているが、NTT内部でお客様の回線に関する作業を行っており、NTTのデータベースにお客様の回線が登録されていない場合に出るエラーとなります。
> NTTの作業が完了すれば自動的に開通していきますが、いつ完了するかにつきましては弊社、JPIXでは確認する事ができません。

とのこと。待ち。

#### 2/14

プロバイダの方で引き続きいろいろ確認してくれたところ、以前のプロバイダの設定が残っているとのこと。

> さきほど開通確認をいたしましたところ、まだ開通されていない状態です。  
> 昨夜エラー内容が変更となっており、「相関オーダーエラー」となっております。  
> これは他社さんで既にv6の開通をされている場合に出るエラーとなっております。  
> v6は同時に複数のプロバイダーでの開通ができないため、他社さんとのご契約を解除していただけますようお願いいたします。

実はNTTに変更を申し込んだ段階で（So-netには何も言っていないのに）So-netから契約プラン変更みたいな連絡[^2]がきていた。v6プラスの契約がこれで切れているのかと勝手に思っていたのだがそんなことはなく、So-netに頼んで設定を引っ込めてもらう必要があるらしい。この連絡を受けたあとにSo-netには退会の申し込み[^3]を済ませていたが、退会の期日は月末であった。チャットで担当者に相談したところ退会は月末から動かせないが、「V6プラス(IPoE(IPv6）オプション)の即時解約」は可能とのことであった[^4]。それを申し込んで会話終了。

#### 2/15

So-netから15時頃にメールがきた。

> このたび、「IPoE(IPv6)オプション」の解約が完了しましたのでご連絡いたします

その旨をCyberBBに伝えたところ、

> 今確認いたしました所　2023/02/15 15:11:00　開通OKとなっております。

キター。設定反映が完了してからメールがくるんだな。

ルータの設定をし直したところ、無事開通していた。1Gbpsを超える結果も出た。やった～。CyberBBの担当者さんありがとう、というか対応が丁寧すぎてびびる。

# 宅内構成

[![](/assets/images/posts/2023-02-17-02-00-52.png){:width="80%" .align-center} ](/assets/images/posts/2023-02-17-02-00-52.png)

現状、有線は ONU - RTX810 - GbEスイッチ1 - 壁内配線 - GbEスイッチ2 - PC となっており、Wi-Fiは ONU - RTX810 - C4000 となっている。前述のように壁内配線が2.5GbE上限と思われるので、最低限はルータ・ハブ2つを2.5GbE対応で揃え、PCにネットワークカードをさすところだろう。ルータを10GbEにすれば壁内配線を通す前の部分は10GbEが使えるようになるのだろうが、デスクトップPCの場所で使えなければあまり意味がない。

しかし現状のRTX810の設定を流用できるしヤマハのルータにしようとすると、GbEを超えるのはRTX1300一択になり、10GbEに対応している。まずこれを買えば、MAP-Eを試すこともできるし、ルータの処理能力が上がってDS-Liteの速度も上がるかもしれない（知らんけど）。ということで、とりあえずRTX1300を注文してみた。13万円少々なり。届いたらまずはRTX810と置き換えて各種速度を計測してみることにする。もし光クロスが導入不可能ということになったら売り払えばよいし。。

### RTX1300

ということで勢いよくRTX1300を買ってしまった。RTX810と比べると前面のサイズは同じくらいだが奥行きが2倍くらいになっている。うーむ。

[![RTX1300の本体。幅より奥行きの方が大きい。](/assets/images/posts/20230115_230911.webp){:width="80%" .align-center} ](/assets/images/posts/20230115_230911.webp)

ひとまず現状の1Gの回線にぶらさげてみる。設定は810のものをほとんどそのまま流し込んだら動いた。偉い。

IPoE（IPv6）の速度はほとんど変わらず600-700Mbpsくらいなのだが、DS-Lite（transix）のv4も600Mbps以上出ていて驚いた。以前は250Mbpsくらいで頭打ちになっていたので、あれはルータ律速だったのだな。いまは回線上限まで出ているようにも見える＆CPU使用率に余裕があるように見えるので、今後もTransixを使うようにしようかしらという気にもなってくる（しないのだが）。

### 宅内2.5GbE化

デスクトップPCに10GbEのネットワークカードを挿し、2.5GbEハブを買い、2.5GbEのUSBネットワークIFをThinkPadにさしてみたところ宅内の配線は普通に2.5GbEが通ることがわかった。規格通りであることはわかるが技術の進化を感じる。

### 開通後

このようになった。

[![](/assets/images/posts/2023-02-17-02-40-49.png){:width="80%" .align-center} ](/assets/images/posts/2023-02-17-02-40-49.png)

ひとまず納戸から自室へのケーブルをRTX1300の10Gポートにつなぎ、自室側は2.5GbEスイッチで受ける。ケーブルの規格準拠の形である。この状態でスピードテストをすると2.3Gbpsほど出る。この結果はOoklaのWindowsアプリでIPv6だが、なんとIPv4（トンネル経由）でも同じくらい出る。MAP-EがすごいのかJPNEがすごいのかわからないが、これはすごい。

[![](/assets/images/posts/2023-02-19-02-28-41.png){:width="60%" .align-center} ](/assets/images/posts/2023-02-19-02-28-41.png)

欲を出して、試しに自室の2.5GbEハブを飛ばして、10GbE NIC（TP-LinkのTX401）を直接（Cat5Eケーブル経由で）RTX1300の10Gポートに接続してみた。ケーブル種別は区別がつかないのだろう、オートネゴシエーションによって10Gでリンクアップする。この状態でテストをすると約7Gbpsが出た。すごい。

[![](/assets/images/posts/2023-02-19-02-32-06.png){:width="60%" .align-center} ](/assets/images/posts/2023-02-19-02-32-06.png)

しかしこの状態で何度かスピードテストをしていたらPC側のNICが固まってしまい全てのネットワークが不通になってしまった（Windows再起動で復帰）。さすがになにか無理があったのだろう。オーバークロックで言えば（？）4倍なわけで、常用できるとはあまり思えない。落ち着いて接続を上図の状態に戻し、2.5GbEで定常運用をすることにした。

追記：と思ったのだが、2.5GbEの状態でもFirefoxでOoklaのスピードテストをやるとたまにNICが固まることが判明（貴重なIPv4の測定方法なのだが）。いまのところここでしか発生していないので様子見でいくが、頻発するならNICを10GbEから2.5GbEに戻すのもよさそう。PCIeのレーンも空くし。

### その他端末

メインで使っているデスクトップPCは無事2.5GbE相当の速度が出るようになった。その他はどうかというと厳しい情勢だ。Wi-Fi勢は実情変化なし（後述）。

常用しているLinuxマシンがある。こいつはDeskmini X300なのでNICを追加することができない。そこでUSBの2.5GbEアダプタをつけてみたのだが、適切なドライバがあたらず1GbE止まりとなってしまう。テストをすると800Mbpsくらいは出るので従来より速くなったといえば速くなったが微妙である。

```console
$ inxi -n
Network:
  Device-1: Realtek RTL8111/8168/8411 PCI Express Gigabit Ethernet
    driver: N/A
  Device-2: Realtek USB 10/100/1G/2.5G LAN type: USB driver: cdc_ncm
  IF: xxx state: up speed: 1000 Mbps duplex: half
    mac: a0:ce:c8:xxx
  IF-ID-1: br-99f036xxxx state: down mac: 02:42:cb:xxx
  IF-ID-2: docker0 state: down mac: 02:42:92:xxx
```

いま気づいたがhalf-duplexやんけ。なんなんだ……。ぐぐるとr8125なりr8168なりというドライバを入れるといいらしいと出てくるのだが、とにかく入らない。kernelとバージョンが合っていない？らしくコンパイルできないらしい。かなしい。ということでLinuxマシンは1GbEにステイである。

また、在宅勤務で使っている会社PCがある。ノートPCなのでこちらもUSBを使うしかない。折良くType-Cにいろいろ刺さるやつで2.5GbEのやつが安くなっていたのでそれを使うようにしてみた。テストをしてみると1Gbpsを超える速度が観測され喜んだのも束の間、会社VPNを有効にすると惨憺たる速度になるのであった（完）。

#### Wi-Fi

さて悩むのはWi-Fiである。いまはWi-Fi5のルータなので、実測400Mbpsで頭打ちになっている。ThinkPadは6E対応なので、一気に6E対応のWi-Fiルータを買ってOver 1Gbpsワールドを目指してみるのもよいかもしれない。よいかもしれないのだが上流10GbEに対応しているルータはNECのWX11000T12くらいしかなく、5万円くらいする。さすがにこれ以上金をかけるのは憚られるので、2.5GbEでもうすこし手頃なやつが出たら考えることにしようと思う。

## NATセッション数

以前問題となっていた突然接続できなくなる現象がNATセッション数上限によるのではないかという疑惑があった。今回MAP-Eになり上限が（不明ではあるがさすがに）増えると思われ、これが解消するという期待がある。RTX1300のダッシュボードでセッション数を監視していると、2日ほど在宅勤務したあとのピーク値が800少々であった。状況次第で増減すると思われるので、過去に1024にあたっていた可能性は高そう。これについてはしばらく値を監視して、1024を超えても問題がないか監視することとしたい。

# まとめ

### よかったこと

- デスクトップPCの常用速度がIPv6: 600Mbps, IPv4: 300Mbpsからどちらも2Gbps超となった
  - 実用上の変化は一切ない
- NATセッション数上限が（たぶん）増えた
  - これは光クロスはあまり関係なく、プロバイダと接続方式を変えたことが要因
- 7Gbpsくらいの測定結果が1回出て楽しかった（小学生並みの感想）
- サポートがまともなプロバイダに乗り換えた

### 悪かったこと

- 金がかかった
  - RTX1300: 14万円くらい
  - NIC: 10GbE NICが1万円くらい、2.5GbE USBアダプタが3000円くらい * 3個
  - ケーブル: Cat6E 数本で3000円くらい
  - スイッチ: 2.5GbEスイッチ1つで1万円くらい
  - 回線
    - 工事費が8000円くらい
    - NTT月額が 6000円くらい（従来比+1000円くらい）
    - プロバイダ月額が2000円くらい（従来比+1000円くらい）

金がかかって仕方ないが、道楽というのはそういうものなので。まあRTX1300が本当に必要だったのか、WX11000T12を1つ買って置いとけばそれだけでよかったんじゃないのか？と言われると弱いが……。

それ以外、特に悪かったことはなさそう。特に速度を雑に制限することなくサポートがちゃんとしているプロバイダを契約できたのでよかった。メールのやりとりが苦痛でないなら[CyberBBさん](https://cyberbb.com/cross.php)はおすすめです。

### 今後チャレンジしたいこと

- 実用を5GbEにする（Cat5Eの規格超えに挑戦）
  - スイッチを買い換えれば挑戦できるが、5GbEのはほとんどないので、自動的に10GbEを買うことになる
- Wi-Fiで1Gbps超えを狙う
  - Wi-Fi6E + 2.5GbEのルータを調達すれば挑戦できるが、そこそこするし、一通り満足してどうでもよくなってきた


[^1]: VPNクライアントの設定でv4/v6を変更できないため、RTX810の設定でVPNホストへのv4アクセスを落としている。するとv6にフォールバックするようだ。
[^2]: So-netからの手紙には「（略）フレッツ光回線を残したまま『So-net光withフレッツ/with フレッツS』サービスを解約する旨の連絡がNTTからございました。つきましては、解約にともなってSo-netのご契約コースが変更になりますので（略）」と書いてある。普通に考えればプロバイダ契約が解除されるものと思うが、なぜか「So-net光アクセス」というプランに勝手に変更されるらしい。月額もなぜか上がって1300円ほどである。率直に言ってカスだと思う。
[^3]: ダークパターンというほどではないが、よくわからんWebをくぐり抜けて退会用のチャットBotにたどり着く必要がある
[^4]: チャットサポートにありがちな要領を得ない担当者であったが、とにかくv6の設定を即日消してくれと頼んだらこのような手続きをしてくれた。結果として正解であった。

---
title: "天体写真のノイズを減らす方法をかんがえる"
date: "2015-11-08"
categories: 
  - "tips"
  - "何か"
tags: 
  - "lightroom"
  - "photoshop"
  - "カメラ"
  - "写真"
  - "天体写真"
---

天体撮影は突き詰めていくと時間との戦いであって、それはつまりノイズと戦うことと同義である。

星が流れない範囲でシャッター時間とISO感度を調整して、画質と明るさのバランスのとれた落としどころを探すというプロセスは必ず必要である。三脚に直接乗せて星景写真を撮るにしろ、赤道儀で追尾して撮るにしろ、無限に撮影できる環境はない。これが普通の夜景なら時間を好きなだけ撮れるので、絞り優先で最も画質の良いところまで絞って、もっともノイズの少ないISO感度にして撮ればよいだけなのだが。

ノイズには複数の種類がある、と思う（自信はない）

1. 暗電流や熱によるノイズ
2. 宇宙線などによる輝点、あとは飛行機とか流星とか
3. 高感度ノイズ
4. まあなんか他にもいろいろありそうだけど影響は小さそう

このうち1は再現性があるので、撮影時と同じ条件(感度・時間・温度など)でレンズキャップをして露光した画像(ダークフレーム)を引き算することで割となかったことにできる。露光時間が長い撮影をしたあとにノイズリダクションなどの処理がカメラで勝手に走るのは、この減算を勝手にやっているのだと思うが、それが保存されるRAW画像に反映されているのかについては謎。メーカーにもよりそうだけど、どうなのだろうか。とりあえず、天体撮影をするときはダーク画像も撮っておいた方がよさそう。

問題は2，3で、ランダムに出るということになっている。これをなんとかするのが画像処理的なノイズリダクションで、カメラ内の処理でもやってると思う、が、例によってこれがRAWに反映されているかは謎である。されてないことを期待しているが、どうなんだろう。Lightroomなどでもノイズ軽減という機能があって、すごい勢いでノイズを除去できる。後からやる前提で、高感度ノイズリダクションはオフにしておいてもよいと思う。

とはいえノイズ除去を強くかければかけるほど解像感は落ちていってぬめっとした画像になってしまうし、悩ましい。

そこでよく使われるのがコンポジット((画像の)合成)である(前置きおわり)。

ランダムで出るのだから、何枚か撮影して、画素ごとに外れ値の画像を無視して、都合の良い画像のデータを採用すればよい、という考え方で、どういう風に都合の良い画像を得るかというアルゴリズムも多岐にわたるらしい（よくわからん）。

また、単純に重ねると、星がずれる分がそのまま合成されてしまってぶれた画像になってしまうので、星の移動にあわせて画像をずらして合わせるという作業が必要である。手でやると非常に辛い。

### Deep Sky Stackerによる合成、を断念

で、最近?はやりのコンポジット用ソフトでDeep sky stackerというのがよいらしいと聞いたので試してみた。ダーク減算はもちろん、フラットフレームの処理とか自動位置合わせもやってくれる優れものとのこと。

- 日本語環境で表示がぶっ壊れてボタンが見えない(Windows10で確認, OSを英語にしたら直った)
- RGBいっしょくたに扱うので色がぶっとぶ

が、上記の問題(おもに2点目)があって断念した。望遠鏡につけるようなカメラってカラーフィルターとか自分でつける前提だろうし、Hαでフィルタして撮った画像とか色もクソもないよなあとかそういうことなのだろうが、とりあえずゆとり写真家には厳しい(赤道儀買う前も同じようなことを言っていたような気がするが)。面倒だからBayer配列のカラーフィルターがついたカメラで撮りたいよ。

色を保ったまま簡単に合成していい感じのトーンカーブにする方法があったら教えてください。

### Lightroom + Photoshopで楽に合成する

で、私のようなズボラなアマチュアカメラマンにとって一番楽にいい感じの結果が得られそうな気がしているのが、Lightroom + Photoshopでコンポジットする方法。

1. 何枚かとったうち、1枚をLightroomで現像する
    - 色とかトーンカーブとか白/黒レベルをいい感じにする
    - ノイズ軽減は弱めにしておく
2. すべてに設定を同期
3. すべて選択して、右クリック→他のツールで編集する→Photoshopでレイヤーとして開く
    - Photoshopに新しい画像ができて、選択した画像がすべてレイヤーとして重なった状態になる
4. レイヤーをすべて選択して、編集→レイヤーを自動整列→「自動」のまま実行
    - 画像が微妙にずれて揃うが、一番上のレイヤの画像しか見えない
5. レイヤーを全て選択して、右クリック→スマートオブジェクトに変換
    - 1つのオブジェクトにまとまる
6. レイヤー→スマートオブジェクト→画像のスタック→「中央値」を選択
7. Tiff画像として保存、Lightroomで追い込む(明瞭度とかね)

とすると、画像の位置合わせと合成ができた画像ができる。ここでは中央値(画像を明るい順にならべて、真ん中の順位の画像を採用)を選んだので、ランダムノイズによって何枚かの画像のうち1枚だけが明るいようなものは捨てられる。中央値以外にも[他にもいろいろアルゴリズムがあり](https://helpx.adobe.com/jp/photoshop/using/image-stacks-photoshop-extended.html)、エントロピーとかいうのが良いとか悪いとか聞いたが、死ぬほど時間がかかる上に結果がいまいちだった。使いどころが悪いのか？平均は案の定全体的に明るくぼやけてしまってダメダメだった。

\[caption id="attachment\_919" align="aligncenter" width="400"\][![M42の比較(等倍)](https://blog.naotaco.com/assets/images/posts/2015/11/M42_composite-400x217.png)](https://blog.naotaco.com/assets/images/posts/2015/11/M42_composite.png) M42の比較(等倍)\[/caption\]

[こないだ撮ってきたM42](https://blog.naotaco.com/archives/868)を7枚コンポジットしたものがこちら。だいぶノイズが除去されているのがわかる。ディテールも若干失われてるような気がするが、、、

ぼけている画像とか、ぶれている画像は事前に捨てる必要がある。あと、いちばん上の2でさらっと書いたのだが、中央値の場合は外れ値の画像をすてるので、流星がたまたま写っていたとしても捨てられてしまう(実際にこのとき7枚のうち1枚に流星か飛行機かが写っていたが、合成後の画像には出てきていない)。そういうときはあとから流星だけ合成してやる必要がありそう(今回みたいな長いレンズだとただの直線状のノイズにしか見えないので、べつに無くてもよいのだが)。

あと、この手順だとダーク減算が入ってないので、ほんとうは3の後に各レイヤからダーク画像を減算してやる必要がある、が、楽にやる方法がよくわかってないので今回は無視する。

とりあえず今回は楽にそこそこ効果のあるコンポジット方法が見いだせたので満足しているが、よりよい結果のためにダーク・フラット補正については考慮する必要がありそう。あと位置合わせの精度とか。
